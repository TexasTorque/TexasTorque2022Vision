# Makefile to compile a local OpenCV program on Unix.

# Constants
BUILD_DIR ?= ./bin
SRC_DIRS ?= ./src
SRCS := $(shell find $(SRC_DIRS) -name *.cpp -or -name *.cc -or -name *.c -or -name *.s)
OBJS := $(SRCS:%=$(BUILD_DIR)/%.o)
DEPS := $(OBJS:.o=.d)
CC = gcc
CXX = g++
DEPS_CFLAGS = -I/usr/local/include/opencv4  # unix only!
DEPS_LIBS = -lopencv_core -lopencv_videoio -lopencv_dnn -lopencv_highgui -lopencv_ml -lopencv_objdetect -lopencv_stitching -lopencv_calib3d -lopencv_videoio -lopencv_imgcodecs -lopencv_features2d -lopencv_video -lopencv_photo -lopencv_imgproc -lopencv_flann 
EXE = local-binary

# Main rule
.PHONY: clean build install

# Rule to build binary
build: $(BUILD_DIR)/${EXE}

# Rule to clean all the .o files generated by the build
clean:
	$(RM) -r $(BUILD_DIR)

# Link all .o files into a single binary
$(BUILD_DIR)/$(EXE): $(OBJS)
	${CXX} -pthread -g -o $@ $^ ${DEPS_LIBS} -Wl 
# --unresolved-symbols=ignore-in-shared-libs

# C++ source files with .cpp extension (non-perfered extension)
$(BUILD_DIR)/%.cpp.o: %.cpp
	$(MKDIR_P) $(dir $@)
	${CXX} -pthread -g -Og -c -o $@ -std=c++17 ${CXXFLAGS} ${DEPS_CFLAGS} $<

# C++ source files with .cc extension (perfered extension)
$(BUILD_DIR)/%.cc.o: %.cc
	$(MKDIR_P) $(dir $@)
	${CXX} -pthread -g -Og -c -o $@ -std=c++17 ${CXXFLAGS} ${DEPS_CFLAGS} $<

# C source files with .c extension (obviously)
$(BUILD_DIR)/%.c.o: %.c
	$(MKDIR_P) $(dir $@)
	${CC} -pthread -g -Og -c -o $@ -std=c17 ${CFLAGS} ${DEPS_CFLAGS} $<
	
MKDIR_P ?= mkdir -p